---
title: "Anàlisi de Dades Òmiques PAC2"
author: "Oriol Nualart Mundó"
date: "30/5/2020"
output: pdf_document
bibliography: bibliography.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#### Enllaç al repositori de GitHub associat a la PAC: <https://github.com/onualart/tiroides.git>

***	

## CONTINGUTS



***	

\newpage

## 1. Abstract

El projecte Genotype-Tissue Expression (GTEx) pretén crear una gran base de dades pública amb informació de l'expressió i regulació gènica en 54 teixits, obtinguda de gairebé 1000 individus, i inclou dades de RNA-seq.

En aquesta anàlisi, partim d'una selecció aleatòria de dades de RNA-seq de mostres de tiroides tretes del projecte GTEx, tant de teixit sa com de teixit parcialment i extensament infiltrat, per detectar gens diferencialment expressatas i buscar patrons biològicament significatius.


***

## 2. Objectius



***

## 3. Materials i mètodes

###     3.1. Disseny de l'experiment



###     3.2. Procediment d'anàlisi de les dades

###        3.2.1. Preparació de les dades

Càrrega de l'arxiu *targets* complet.

```{r}
targets_big <- read.csv2("./data/targets.csv", header = TRUE, sep = ",")
```


Correcció dels noms de les mostres a *targets_all*.

```{r}
library(stringr)

sample_names <- targets_big$Sample_Name

sample_names <- str_replace_all(sample_names, "-", ".")

targets_big$Sample_Name <- sample_names
```



Càrrega de l'arxiu *counts*.

```{r}
counts_big <- read.csv2("./data/counts.csv", header = TRUE, sep = ";")
```


Selecció aleatòria de mostres.

```{r}
set.seed(123)

samplNIT <- sample(which(targets_big$Group == "NIT"), 10)

samplSFI <- sample(which(targets_big$Group == "SFI"), 10)

samplELI <- sample(which(targets_big$Group == "ELI"), 10)

samples <- c(samplNIT, samplSFI, samplELI)
```


Creació d'un data frame *targets* que contingui només les mostres seleccionades.

```{r}
targets <- targets_big[samples,]
```


Creació d'un data frame *counts* que contingui només les mostres seleccionades.

```{r}
columns <- targets$Sample_Name

counts <- counts_big[columns]

X <- c()

for (i in 1:length(counts_big$X)) {
X[i] <- substring(counts_big$X[i], 1, 15)
}

row.names(counts) <- X
colnames(counts) <- targets$ShortName
```


Construcció de l'objecte *DESeqDataSet* a partir dels data frames *counts* i *targets*.

```{r}
library(DESeq2)

dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = targets,
                              design = ~ sex + Group)
dds$Group <- factor(dds$Group, levels = c("NIT","SFI", "ELI"))
dds
```


###        3.2.2. Control de qualitat i filtratge.

Per fer el control de qualitat primer transformem les dades en *pseudocounts* utilitzant la fórmula $y = log_{2}(K+1)$. Això ens permetrà visualitzar la distribució de les dades, ja que les dades crues queden massa concentrades en els gràfics.

```{r}
pseudoCounts <- log2(counts + 1)
```


Generem un boxplot per comparar les mostres.

```{r}
library(reshape2)
library(ggplot2)
df <- melt(pseudoCounts, variable.name = "Samples")
df$Grup <- c(rep("NIT", 562020), rep("SFI", 562020), rep("ELI", 562020))
ggplot(df, aes(x = Samples, y = value)) + geom_boxplot(aes(fill = factor(Grup))) + xlab("Mostra") +
ylab(expression(log[2](count + 1))) + theme(axis.text.x = element_text(angle = 65, hjust = 1.2, vjust = 1.2))
```

No observem grans diferències entre les mostres. L'única que potser destaca és la mostra R55G_ELI, que té un número de *counts* inferior a la resta.



Comparem les mostres també amb un histograma.

```{r}
ggplot(df, aes(x = value, colour = Samples)) + ylim(c(0, 0.17)) + xlim(c(0, 17)) +
geom_density(alpha = 0.2, size = 0.75)  +
theme(legend.position = "top") + xlab(expression(log[2](count + 1)))
```

De nou, trobem que en general no hi ha grans variacions entre les mostres, excepte en el cas de R55G_ELI, que en aquest gràfic sí que es veu més clarament diferenciada.

De totes maneres, amb el que podem veure en els gràfics (la distribució dels quartils i els *outliers* al *boxplot*, i la forma de la corva a l'histograma), és probable que això afecti de forma semblant a tots els gens, i en aquest cas quedarà en part corregit amb la normalització.

Es tracta d'una mostra del grup de teixit extensivament infiltrat, i per tant esperem una major variabilitat en els nivells d'expressió gènica. En aquest cas els nivells d'expressió semblen força diferents dels de la resta del grup, però no podem descartar que la variació sigui deguda a la condició d'estudi -cosa que aportaria informació rellevant-, i per tant optarem per mantenir-la en l'anàlisi.


Per generar la resta de gràfics del control de qualitat ens convé estabilitzar la variança. Ho farem amb la funció *rlog*, i no amb l'alternativa *vst*, ja que el temps de computació no és un problema.

Abans, però, filtrem el *DESeqDataSet* per eliminar les files amb un número total de *counts* de 0 o 1.

```{r}
dds <- dds[ rowSums(counts(dds)) > 1, ]
nrow(dds)
```



```{r}
rld <- rlog(dds)
```


Distància entre mostres.Heatmap.

```{r}
sampleDists <- dist(t(assay(rld)))

library("pheatmap")
library("RColorBrewer")

sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( rld$ShortName, rld$sex, sep = " - " )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)
```


Gràfic de l'anàlisi de components principals.

```{r}
plotPCA(rld, intgroup = c("Group", "sex"))
```


Un altre gràfic que podem fer per veure com s'agrupen les mostres és un heatmap de la variança dels 20 gens amb expressió més variable. Per fer-lo, treballem a partir de les dades amb variança reduïda mitjançant RLOG.

```{r}
library("genefilter")
topVarGenes <- head(order(rowVars(assay(rld)), decreasing = TRUE), 20)

mat  <- assay(rld)[topVarGenes, ]
mat  <- mat - rowMeans(mat)
anno <- as.data.frame(colData(rld)[, c("sex","Group")])
pheatmap(mat, annotation_col = anno)
```

Observem que les mostres s'agrupen principalment en dos grups, un que inclou la majoria de mostres del grup ELI i algunes del grup SFI, i un altre que inclou la resta de mostres. També crida l'atenció que dintre d'aquests dos grups les mostres es separen clarament per sexes.

###        3.2.3. Normalització.

Per tenir en compte les diferències sistemàtiques d'orígen tècnic entre mostres, apliquem una normalització. Aquesta consisteix en multiplicar el número de *counts* de cada mostra del nostre *DESeqDataSet* per una constant *C_{j}* que calculem a partir de les dades de *counts* de la mateixa mostra. El tipus de normalització que apliquem variarà en funció del tipus de càlcul que fem per obtenir *C_{j}*.

En aquest cas utilitzarem el mètode RLE (*Relative Log Expression*, Anders and Huber 2010), que, partint de la mitjana geomètrica de l'expressió entre mostres, crea una "mostra de pseudo-referència" sobre la qual centrar les dades de les diferents mostres. Després de centrar les dades, busca la mitjana entre gens per a cada mostra.

Aquest mètode es pot implementar amb la funció *estimateSizeFactors* del paquet *DESeq2*.


```{r}
dds <- estimateSizeFactors(dds)
```


###        3.2.4. Anàlisi d'expressió diferencial.

L'anàlisi d'expressió diferencial consisteix en fer, per a cada contrast d'interès, tests de significació en un model binomial negatiu. Els paràmetres del model són desconeguts, però podem obtenir-ne una estimació.

La funció *estimateDispersions* del paquet *DESeq2* fa una estimació dels paràmetres de dispersió de les dades, a partir de la qual podrem obtenir els paràmetres del model.

* Primer fa un càlcul preliminar de la dispersió de cada gen mitjançant una estimació per màxima veosimilitud (McCarthy, Chen, and Smyth 2012).

* Després encongieix els valors acostant-los a la corva ajustada definida per aquesta mateixa estimació preliminar.

```{r}
dds <- estimateDispersions(dds)
```


Un cop estimats els paràmetres de dispersió podem passar a fer l'anàlisi d'expressió diferencial en sí. Convé recordar que al crear l'objecte *DESeqDataSet* ja hem especificat els factors que volem incloure a la nostra matriu de disseny.

La funció *nbinomWaldTest* del paquet *DESeq2* fa el càlcul del test per a cada gen dintre de cada comparació, i afegeix els resultats al *DESeqDataSet* com a metadades. Aquests resultats inclouen el Log_{2} del fold-change, el p-valor i el p-valor ajustat del contrast.


```{r}
dds <- nbinomWaldTest(dds)
```


Utilitzem la funció *results* per explorar els resultats dels diferents contrasts.

Entre els grups "ELI" i "NIT", mirem primer un resum dels resultats.

```{r}
resELIvsNIT <- results(dds, contrast=c("Group","NIT","ELI"))

summary(resELIvsNIT)
```


També mirem alguns dels valors associats als gens que tenen un diferencial d'expressió positiu i negatiu més gran.

```{r}
resSigELIvsNIT <- subset(resELIvsNIT, padj < 0.1)
valSigELIvsNIT <- resSigELIvsNIT[c("log2FoldChange", "pvalue", "padj")]
head(valSigELIvsNIT[ order(valSigELIvsNIT$log2FoldChange, decreasing = TRUE), ], 3)
head(valSigELIvsNIT[ order(valSigELIvsNIT$log2FoldChange), ], 3)
```


També fem un MA plot del contrast. Per fer-lo, primer hem d'encongir el log2 dels fold changes amb la funció *lfcShrink*.

```{r}
shrELIvsNIT <- lfcShrink(dds, contrast=c("Group","NIT","ELI"))
plotMA(shrELIvsNIT, ylim = c(-5, 5))
```

Observem que en el teixit infiltrat, respecte el no infiltrat, hi ha un major nombre de gens inhibits que de gens sobreexpressats, i aquests gens inhibits mostren un major fold change i un nivell més alt de significació (un p-valor més petit). Això segurament s'explica perquè les diferències d'expressió en el teixit infiltrat tendeixen per naturalesa a ser en forma d'inhibició de molts gens reguladors.


Explorem el contrast entre els grups "SFI" i "NIT".

```{r}
resSFIvsNIT <- results(dds, contrast=c("Group","NIT","SFI"))

summary(resSFIvsNIT)
```


```{r}
resSigSFIvsNIT <- subset(resSFIvsNIT, padj < 0.1)
valSigSFIvsNIT <- resSigSFIvsNIT[c("log2FoldChange", "pvalue", "padj")]
head(valSigSFIvsNIT[ order(valSigSFIvsNIT$log2FoldChange, decreasing = TRUE), ], 3)
head(valSigSFIvsNIT[ order(valSigSFIvsNIT$log2FoldChange), ], 3)
```


MA plot.

```{r}
shrSFIvsNIT <- lfcShrink(dds, contrast=c("Group","NIT","SFI"))

plotMA(shrSFIvsNIT, ylim = c(-5, 5))
```


En aquest cas també trobem diferències en el mateix sentit: el grup de teixit parcialment infiltrat té més gens inhibits que gens sobreexpressats respecte el grup de teixit no infiltrat. La diferència és que el número de gens diferencialment expressats és menor que en l'anterior comparació.


Explorem els resultats del contrast entre els grups "ELI" i "SFI".

```{r}
resELIvsSFI <- results(dds, contrast=c("Group","SFI","ELI"))

summary(resELIvsSFI)
```


```{r}
resSigELIvsSFI <- subset(resELIvsSFI, padj < 0.1)
valSigELIvsSFI <- resSigELIvsSFI[c("log2FoldChange", "pvalue", "padj")]
head(valSigELIvsSFI[ order(valSigELIvsSFI$log2FoldChange, decreasing = TRUE), ], 3)
head(valSigELIvsSFI[ order(valSigELIvsSFI$log2FoldChange), ], 3)
```


```{r}
shrELIvsSFI <- lfcShrink(dds, contrast=c("Group","SFI","ELI"))

plotMA(shrELIvsSFI, ylim = c(-5, 5))
```

En aquest cas estem comparant un grup de mostres de teixit extensament infiltrat amb un grup de mostres de teixit parcialment infiltrat. Observem que hi ha força gens diferencialment expressats, però en aquest cas no n'hi ha gaires més d'inhibits que de sobreexpressats. Tant el fold change com el nivell de significació dels gens més diferencialment expressats són menors que en les anteriors comparacions.


###        3.2.5. Anotació dels resultats.

Per poder seguir amb l'anàlisi de les dades, necessitem associar als gens que hem detectat com a diferencialment expressats el *gene symbol* i l'*Entrez ID* corresponents.

```{r}
library("EnsDb.Hsapiens.v86")
library("AnnotationDbi")

columns(EnsDb.Hsapiens.v86)
```

```{r}
keytypes(EnsDb.Hsapiens.v86)
```


```{r}
resSigELIvsNIT$symbol  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigELIvsNIT),
                                 column="SYMBOL", keytype="GENEID", multiVals="first")

resSigELIvsNIT$entrez  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigELIvsNIT),
                                 column="ENTREZID", keytype="GENEID",
                                 multiVals="first")

resSigSFIvsNIT$symbol  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigSFIvsNIT),
                                 column="SYMBOL", keytype="GENEID", multiVals="first")

resSigSFIvsNIT$entrez  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigSFIvsNIT),
                                 column="ENTREZID", keytype="GENEID",
                                 multiVals="first")

resSigELIvsSFI$symbol  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigELIvsSFI),
                                 column="SYMBOL", keytype="GENEID", multiVals="first")

resSigELIvsSFI$entrez  <- mapIds(EnsDb.Hsapiens.v86, keys=row.names(resSigELIvsSFI),
                                 column="ENTREZID", keytype="GENEID",
                                 multiVals="first")
```


Ordenació dels resultats.

```{r}
resOrdELIvsNIT <- resSigELIvsNIT[order(resSigELIvsNIT$padj),]

resOrdSFIvsNIT <- resSigSFIvsNIT[order(resSigSFIvsNIT$padj),]

resOrdELIvsSFI <- resSigELIvsSFI[order(resSigELIvsSFI$padj),]
```


Exportació dels resultats a arxius csv.

```{r}
dfELIvsNIT <- as.data.frame(resOrdELIvsNIT)
write.csv(dfELIvsNIT, file = "results/resultsELIvsNIT.csv")

dfSFIvsNIT <- as.data.frame(resOrdSFIvsNIT)
write.csv(dfSFIvsNIT, file = "results/resultsSFIvsNIT.csv")

dfELIvsSFI <- as.data.frame(resOrdELIvsSFI)
write.csv(dfELIvsSFI, file = "results/resultsELIvsSFI.csv")
```








